<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Platform Statistics</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Segoe UI", sans-serif; background: #f6f8fa; margin: 0; padding: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #ff6b95; }
        .stat-label { color: #666; margin-top: 5px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .charts-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .top-lists { display: flex; gap: 20px; flex-wrap: wrap; }
        .top-list { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex: 1; }
        .top-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .rank { background: #ff6b95; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .title { font-weight: bold; margin-bottom: 5px; }
        .meta { font-size: 12px; color: #666; }
        .no-data { text-align: center; color: #888; margin-top: 15px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .container { padding: 30px; }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <a th:href="@{/posts}" class="nav-brand">Posts</a>
        <a th:href="@{/pets/main}" class="nav-brand">PawPal</a>
        <a th:href="@{/api/users/main}" class="nav-brand">Users</a>

        <a th:href="@{/statistics}" class="nav-brand admin-btn">
            <i class="fa-solid fa-chart-bar"></i> Statistics
        </a>

        <div class="notif-icon">
            <a th:href="@{/notifications}" title="Notifications">
                <i class="fa-solid fa-bell" style="font-size: 20px; color: pink;"></i>
                <span th:if="${#lists.size(requests) + #lists.size(postNotifications) > 0}"
                      th:text="${#lists.size(requests) + #lists.size(postNotifications)}"
                      class="notif-badge"></span>
            </a>
        </div>
        <div class="nav-profile">
            <a th:href="@{/api/users/viewProfile/{id}(id=${user.userId})}">
                <img th:src="@{${user.profilePicture != null ? user.profilePicture : '/css/images/default-avatar.jpg'}}"
                     alt="Profile"
                     class="avatar"
                     onerror="this.src='/css/images/default-avatar.jpg'">
            </a>
        </div>
    </div>
</nav>
<div class="container">
    <div class="header-container">
        <h1>üìà Platform Statistics</h1>
        <p>Real-time analytics and insights</p>
        <a th:href="@{/statistics/export}" class="btn btn-primary">‚¨á Export CSV</a>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" th:text="${stats.generalStats.totalPosts}">0</div>
            <div class="stat-label">Total Posts</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${stats.generalStats.totalUsers}">0</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${stats.generalStats.totalPets}">0</div>
            <div class="stat-label">Total Pets</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${stats.generalStats.totalLikes}">0</div>
            <div class="stat-label">Total Likes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${#numbers.formatDecimal(stats.generalStats.averageLikesPerPost,1,2)}">0</div>
            <div class="stat-label">Avg Likes/Post</div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-row">
        <div class="chart-container" style="flex: 2;">
            <h3>üìä Platform Overview</h3>
            <canvas id="overviewChart"></canvas>
        </div>

        <div class="chart-container" id="typeChartContainer" style="flex: 1;" th:if="${stats.typeStats != null and !#lists.isEmpty(stats.typeStats)}">
            <h3>üê∂ Pets by Type</h3>
            <canvas id="typeChart"></canvas>
        </div>
    </div>

    <!-- –¢–æ–ø–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ø–æ—Å—Ç—ã -->
    <div class="top-lists">
        <div class="top-list">
            <h3>üèÜ Top Posts by Likes</h3>
            <div th:each="post, iter : ${stats.topRatedPosts}" class="top-item">
                <span class="rank" th:text="${iter.index + 1}">1</span>
                <div class="content">
                    <div class="title" th:text="${post.postContent}">Post content</div>
                    <div class="meta">
                        <span th:text="${post.userName}">User</span> ‚Ä¢
                        <span th:text="${post.likeCount}">0</span> likes ‚Ä¢
                        <span th:text="${post.commentCount}">0</span> comments
                    </div>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(stats.topRatedPosts)}" class="no-data"><p>No posts yet</p></div>
        </div>

        <div class="top-list">
            <h3>üë• Top Users</h3>
            <div th:each="u, iter : ${stats.topUsers}" class="top-item">
                <span class="rank" th:text="${iter.index + 1}">1</span>
                <div class="content">
                    <div class="title" th:text="${u.userName}">Username</div>
                    <div class="meta">
                        <span th:text="${u.postCount}">0</span> posts ‚Ä¢
                        <span th:text="${u.totalLikes}">0</span> likes ‚Ä¢
                        <span th:text="${u.commentCount}">0</span> comments
                    </div>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(stats.topUsers)}" class="no-data"><p>No users yet</p></div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const overviewLabels = ['Posts', 'Users', 'Pets', 'Likes'];
    const overviewData = [
        /*[[${stats.generalStats.totalPosts}]]*/,
        /*[[${stats.generalStats.totalUsers}]]*/,
        /*[[${stats.generalStats.totalPets}]]*/,
        /*[[${stats.generalStats.totalLikes}]]*/
    ];

    // –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    new Chart(document.getElementById('overviewChart'), {
        type: 'bar',
        data: {
            labels: overviewLabels,
            datasets: [{
                label: 'Platform Metrics',
                data: overviewData,
                backgroundColor: ['#ff6b95', '#74c0fc', '#63e6be', '#ffd43b'],
                borderWidth: 1
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –ø–∏—Ç–æ–º—Ü–µ–≤ –ø–æ —Ç–∏–ø—É
    const typeStats = /*[[${stats.typeStats}]]*/ [];
    const typeLabels = typeStats.map(t => t.type);
    const typeData   = typeStats.map(t => t.count);

    if(typeLabels.length > 0) {
        new Chart(document.getElementById('typeChart'), {
            type: 'pie',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeData,
                    backgroundColor: ['#ff6b95', '#74c0fc', '#63e6be', '#ffd43b', '#da77f2', '#ffa94d']
                }]
            },
            options: { responsive: true }
        });
    } else {
        document.getElementById('typeChartContainer').style.display = 'none';
    }
    /*]]>*/
</script>

</body>
</html>
