<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Create Post - PawPal</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        :root{
            --accent1:#ff6390;
            --accent2:#ff8fab;
            --muted:#888;
            --bg:#fffafc;
            --card:#ffffff;
            --radius:14px;
            --shadow:0 10px 30px rgba(255,107,149,0.08);
            --max-width:900px;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family:Inter,system-ui,Arial,sans-serif;
            background:linear-gradient(180deg,#fffefe 0%, #fff7fb 100%);
            color:#222;
            padding:24px;
            display:flex;
            justify-content:center;
        }
        .container{
            width:100%;
            max-width:var(--max-width);
            margin:20px;
        }

        .card{
            background:var(--card);
            border-radius:var(--radius);
            padding:26px;
            box-shadow:var(--shadow);
            border:1px solid rgba(255,183,206,0.12);
        }

        .header{
            display:flex;
            gap:18px;
            align-items:center;
            margin-bottom:18px;
        }
        .logo{
            width:68px;
            height:68px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--accent1),var(--accent2));
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:26px;
            box-shadow:0 6px 18px rgba(255,107,149,0.12);
        }
        h1{margin:0;font-size:24px}
        p.lead{margin:0;color:var(--muted);font-size:14px}

        form .field{margin-top:18px}
        label.field-label{
            display:flex;
            align-items:center;
            gap:10px;
            font-weight:600;
            color:var(--accent1);
            font-size:13px;
            text-transform:uppercase;
            letter-spacing:0.8px;
            margin-bottom:10px;
        }

        textarea#postContent{
            width:100%;
            min-height:140px;
            padding:16px;
            border-radius:12px;
            border:1px solid #ffeef4;
            background:rgba(255,255,255,0.9);
            resize:vertical;
            font-size:15px;
            line-height:1.5;
            box-shadow:inset 0 6px 18px rgba(255,183,206,0.03);
        }
        .meta-row{
            display:flex;
            gap:12px;
            align-items:center;
            justify-content:space-between;
            margin-top:8px;
        }
        .char-count{color:var(--muted);font-size:13px}

        /* Upload blocks */
        .uploads{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:14px;
            margin-top:6px;
        }
        .upload-block{
            border-radius:12px;
            border:2px dashed rgba(255,183,206,0.5);
            padding:10px;
            min-height:150px;
            background:linear-gradient(180deg, #fffaff, #fff5f8);
            position:relative;
            transition:all .18s ease;
            display:flex;
            flex-direction:column;
        }
        .upload-block.dragover{
            transform:translateY(-4px);
            border-color:var(--accent1);
            box-shadow:0 12px 30px rgba(255,107,149,0.08);
        }
        .upload-block .hint{
            text-align:center;
            color:var(--muted);
            font-size:13px;
            margin-top:6px;
        }
        .upload-block .input-wrap{
            position:relative;
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .upload-block input[type=file]{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            opacity:0;
            cursor:pointer;
        }

        .preview-grid{
            margin-top:12px;
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
            gap:10px;
        }
        .preview-item{
            border-radius:10px;
            overflow:hidden;
            background:#fff;
            border:1px solid #fff5f8;
            box-shadow:0 6px 18px rgba(0,0,0,0.04);
            position:relative;
            min-height:80px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .preview-item img,
        .preview-item video{
            width:100%;
            height:100%;
            object-fit:cover;
            display:block;
        }
        .preview-item audio{
            width:100%;
            padding:6px;
        }
        .preview-remove{
            position:absolute;
            top:6px;
            right:6px;
            width:30px;
            height:30px;
            border-radius:8px;
            background:linear-gradient(135deg,#ff6b6b,#ff5252);
            color:#fff;
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:13px;
            box-shadow:0 6px 14px rgba(255,80,120,0.12);
        }

        /* tags row */
        .tags-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        select[multiple]{
            width:100%;
            padding:10px;
            border-radius:10px;
            border:1px solid #ffeef4;
            background:rgba(255,255,255,0.9);
            min-height:44px;
            font-size:14px;
        }
        input[type=text].new-tags{
            padding:10px;border-radius:10px;border:1px solid #ffeef4;width:100%;
        }

        .actions{
            display:flex;
            gap:12px;
            justify-content:flex-end;
            margin-top:18px;
        }
        .btn{
            padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
        }
        .btn.primary{
            background:linear-gradient(135deg,var(--accent1),var(--accent2));
            color:white;
            box-shadow:0 10px 30px rgba(255,107,149,0.18);
        }
        .btn.ghost{
            background:transparent;border:1px solid #eee;color:#333;
        }

        /* Responsive */
        @media (max-width:880px){
            .uploads{grid-template-columns:1fr; }
        }

        @media (max-width:520px){
            body{padding:14px}
            .header{gap:12px}
            h1{font-size:20px}
        }

    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="header">
            <div class="logo"><i class="fa-solid fa-paw"></i></div>
            <div>
                <h1>Create New Post</h1>
                <p class="lead">Share photos, videos or audio about your pet — choose tags and hit Publish.</p>
            </div>
        </div>

        <!-- Thymeleaf form -->
        <form th:action="@{/posts/add}" th:object="${post}" method="post" enctype="multipart/form-data" id="createPostForm">
            <!-- Content -->
            <div class="field">
                <label class="field-label" for="postContent"><i class="fa-solid fa-pen-fancy"></i> Your Story</label>
                <textarea id="postContent" th:field="*{postContent}" maxlength="1000"
                          placeholder="What's on your mind? Tell a story or share a memory..." required></textarea>
                <div class="meta-row">
                    <div class="char-count"><span id="charCount">0</span>/1000</div>
                    <div style="color:var(--muted);font-size:13px">You can attach photos, videos, and audio files.</div>
                </div>
            </div>

            <!-- Uploads -->
            <div class="field">
                <div class="field-label"><i class="fa-solid fa-photo-film"></i> Attach Media</div>

                <div class="uploads">
                    <!-- Photos -->
                    <div class="upload-block" id="photosBlock" data-type="image">
                        <div class="input-wrap">
                            <div style="text-align:center;">
                                <strong>Photos</strong>
                                <div class="hint">Drag & drop or click to select (max <span id="maxPhotos">10</span>)</div>
                            </div>
                            <input type="file" id="photosInput" name="photos" accept="image/*" multiple>
                        </div>
                        <div class="preview-grid" id="photosPreview"></div>
                    </div>

                    <!-- Videos -->
                    <div class="upload-block" id="videosBlock" data-type="video">
                        <div class="input-wrap">
                            <div style="text-align:center;">
                                <strong>Videos</strong>
                                <div class="hint">Drag & drop or click (max <span id="maxVideos">3</span>)</div>
                            </div>
                            <input type="file" id="videosInput" name="videos" accept="video/*" multiple>
                        </div>
                        <div class="preview-grid" id="videosPreview"></div>
                    </div>

                    <!-- Audios -->
                    <div class="upload-block" id="audiosBlock" data-type="audio">
                        <div class="input-wrap">
                            <div style="text-align:center;">
                                <strong>Audio</strong>
                                <div class="hint">Drag & drop or click (max <span id="maxAudios">5</span>)</div>
                            </div>
                            <input type="file" id="audiosInput" name="audios" accept="audio/*" multiple>
                        </div>
                        <div class="preview-grid" id="audiosPreview"></div>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="field">
                <label class="field-label"><i class="fa-solid fa-tags"></i> Tags</label>
                <div class="tags-row">
                    <select id="tagsSelect" name="selectedTags" multiple th:each="tag : ${tags}">
                        <option th:value="${tag.name}" th:text="${tag.name}"></option>
                    </select>
                </div>
                <div style="margin-top:8px">
                    <input type="text" name="newTags" class="new-tags" placeholder="Add new tags separated by commas (optional)">
                </div>
            </div>
            <div class="form-group">
                <label for="pollQuestion" class="form-label">
                    <i class="fa-solid fa-poll"></i>
                    Poll Question (Optional)
                </label>
                <input type="text"
                       id="pollQuestion"
                       name="pollQuestion"
                       placeholder="Ask a question for your poll"
                       class="form-textarea">
            </div>

            <div class="form-group">
                <label for="pollOptionsRaw" class="form-label">
                    <i class="fa-solid fa-list"></i>
                    Poll Options (comma separated)
                </label>
                <input type="text"
                       id="pollOptionsRaw"
                       name="pollOptionsRaw"
                       placeholder="Option1, Option2, Option3"
                       class="form-textarea">
                <small style="color:#999; font-style:italic;">
                    Separate options with commas. Minimum 2 options required if question is set.
                </small>
            </div>


            <div class="actions">
                <a th:href="@{/posts}" class="btn ghost"><i class="fa-solid fa-arrow-left"></i>&nbsp;Back</a>
                <button type="submit" class="btn primary"><i class="fa-solid fa-rocket"></i>&nbsp;Publish Post</button>
            </div>
        </form>
    </div>
</div>

<script>
    (function(){
        // Config
        const MAX_PHOTOS = 10;
        const MAX_VIDEOS = 3;
        const MAX_AUDIOS = 5;

        // Elements
        const textarea = document.getElementById('postContent');
        const charCount = document.getElementById('charCount');

        const photosBlock = document.getElementById('photosBlock');
        const videosBlock = document.getElementById('videosBlock');
        const audiosBlock = document.getElementById('audiosBlock');

        const photosInput = document.getElementById('photosInput');
        const videosInput = document.getElementById('videosInput');
        const audiosInput = document.getElementById('audiosInput');

        const photosPreview = document.getElementById('photosPreview');
        const videosPreview = document.getElementById('videosPreview');
        const audiosPreview = document.getElementById('audiosPreview');

        // DataTransfer objects to manage files programmatically
        const dtPhotos = new DataTransfer();
        const dtVideos = new DataTransfer();
        const dtAudios = new DataTransfer();

        // Init count
        charCount.textContent = textarea.value.length || 0;

        // Char counter
        textarea.addEventListener('input', () => {
            const len = textarea.value.length;
            charCount.textContent = len;
        });

        // Generic handlers
        function setupBlock(blockEl, inputEl, previewEl, dtObj, maxCount, acceptPrefix) {
            // drag events
            ['dragenter','dragover'].forEach(ev => {
                blockEl.addEventListener(ev, (e) => {
                    e.preventDefault();
                    blockEl.classList.add('dragover');
                });
            });
            ['dragleave','dragend','drop'].forEach(ev => {
                blockEl.addEventListener(ev, (e) => {
                    e.preventDefault();
                    blockEl.classList.remove('dragover');
                });
            });

            blockEl.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = Array.from(e.dataTransfer.files || []);
                handleFilesAdd(files, inputEl, previewEl, dtObj, maxCount, acceptPrefix);
            });

            inputEl.addEventListener('change', () => {
                const files = Array.from(inputEl.files || []);
                handleFilesAdd(files, inputEl, previewEl, dtObj, maxCount, acceptPrefix);
            });
        }

        function handleFilesAdd(files, inputEl, previewEl, dtObj, maxCount, acceptPrefix) {
            // filter and validate
            for (const file of files) {
                if (dtObj.files.length >= maxCount) {
                    alert(`Maximum ${maxCount} files allowed for this type.`);
                    break;
                }

                if (!file.type) continue;

                if (!file.type.startsWith(acceptPrefix)) {
                    // allow some common mismatches (e.g., mp4 videos often video/mp4) but we require prefix
                    alert(`File "${file.name}" skipped — invalid type (${file.type}).`);
                    continue;
                }

                dtObj.items.add(file);
            }

            // sync to input
            inputEl.files = dtObj.files;
            renderPreviews(previewEl, dtObj, inputEl === photosInput ? 'image' : (inputEl === videosInput ? 'video' : 'audio'));
        }

        function renderPreviews(previewEl, dtObj, kind) {
            previewEl.innerHTML = '';
            Array.from(dtObj.files).forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = 'preview-item';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'preview-remove';
                removeBtn.type = 'button';
                removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                removeBtn.addEventListener('click', () => {
                    removeFileAt(dtObj, idx, previewEl, kind);
                });

                if (kind === 'image') {
                    const img = document.createElement('img');
                    const reader = new FileReader();
                    reader.onload = (e) => img.src = e.target.result;
                    reader.readAsDataURL(file);
                    item.appendChild(img);
                } else if (kind === 'video') {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.muted = true;
                    video.playsInline = true;
                    const reader = new FileReader();
                    reader.onload = (e) => { video.src = e.target.result; };
                    reader.readAsDataURL(file);
                    item.appendChild(video);
                } else { // audio
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    const reader = new FileReader();
                    reader.onload = (e) => { audio.src = e.target.result; };
                    reader.readAsDataURL(file);
                    item.appendChild(audio);
                }

                item.appendChild(removeBtn);
                previewEl.appendChild(item);
            });
        }

        function removeFileAt(dtObj, index, previewEl, kind) {
            // create new DataTransfer without the index
            const newDt = new DataTransfer();
            Array.from(dtObj.files).forEach((f, i) => { if (i !== index) newDt.items.add(f); });
            // copy back
            while (dtObj.items.length) dtObj.items.remove(0); // clear old (some browsers allow assignment but we keep dtObj reference)
            // dtObj is local DataTransfer and can't be mutated easily; instead set corresponding DataTransfer variable
            if (kind === 'image') {
                // replace dtPhotos content
                replaceDataTransfer(dtPhotos, newDt);
                photosInput.files = dtPhotos.files;
                renderPreviews(photosPreview, dtPhotos, 'image');
            } else if (kind === 'video') {
                replaceDataTransfer(dtVideos, newDt);
                videosInput.files = dtVideos.files;
                renderPreviews(videosPreview, dtVideos, 'video');
            } else {
                replaceDataTransfer(dtAudios, newDt);
                audiosInput.files = dtAudios.files;
                renderPreviews(audiosPreview, dtAudios, 'audio');
            }
        }

        // Helper to copy files from one DataTransfer to another
        function replaceDataTransfer(targetDt, sourceDt) {
            // clear target
            while (targetDt.items.length) targetDt.items.remove(0);
            Array.from(sourceDt.files).forEach(f => targetDt.items.add(f));
        }

        // Initialization
        setupBlock(photosBlock, photosInput, photosPreview, dtPhotos, MAX_PHOTOS, 'image');
        setupBlock(videosBlock, videosInput, videosPreview, dtVideos, MAX_VIDEOS, 'video');
        setupBlock(audiosBlock, audiosInput, audiosPreview, dtAudios, MAX_AUDIOS, 'audio');

        // On submit: ensure form inputs are populated with current DataTransfer (already synced on add/remove)
        const form = document.getElementById('createPostForm');
        form.addEventListener('submit', (e) => {
            // example final validation: require at least one media or textual content
            const hasText = textarea.value && textarea.value.trim().length > 0;
            const hasAnyMedia = dtPhotos.files.length || dtVideos.files.length || dtAudios.files.length;
            if (!hasText && !hasAnyMedia) {
                e.preventDefault();
                alert('Please add text or at least one media file before posting.');
                return false;
            }
            // inputs already have files bound (we updated them on each change)
            return true;
        });

        // Set numeric labels
        document.getElementById('maxPhotos').textContent = MAX_PHOTOS;
        document.getElementById('maxVideos').textContent = MAX_VIDEOS;
        document.getElementById('maxAudios').textContent = MAX_AUDIOS;

    })();
</script>
</body>
</html>
